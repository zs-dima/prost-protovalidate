name: Publish

on:
  push:
    tags:
      - "v*"

env:
  CARGO_TERM_COLOR: always

jobs:
  publish:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    environment: crates-io
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: sudo apt-get install -y protobuf-compiler

      - name: Verify version matches tag
        run: |
          TAG=${GITHUB_REF#refs/tags/v}
          for crate in crates/prost-protovalidate-types crates/prost-protovalidate; do
            VERSION=$(cargo metadata --no-deps --format-version 1 | jq -r ".packages[] | select(.manifest_path | endswith(\"$crate/Cargo.toml\")) | .version")
            if [ "$VERSION" != "$TAG" ]; then
              echo "::error::Version mismatch in $crate: Cargo.toml=$VERSION, tag=$TAG"
              exit 1
            fi
          done

      - name: Dry run (types crate only; main crate depends on types being published first)
        run: cargo publish --dry-run -p prost-protovalidate-types

      # Publish in dependency order with index propagation delay
      - name: Publish prost-protovalidate-types
        run: cargo publish -p prost-protovalidate-types
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Wait for index
        run: sleep 30

      - name: Publish prost-protovalidate
        run: cargo publish -p prost-protovalidate
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
