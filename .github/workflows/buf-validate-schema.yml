name: buf-validate-schema

on:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  schema-drift-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Setup Buf
        uses: bufbuild/buf-setup-action@v1

      - name: Sync pinned buf.validate schema
        working-directory: crates/prost-protovalidate-types
        run: |
          buf dep update
          mkdir -p proto/buf/validate
          buf export buf.build/bufbuild/protovalidate --output proto --path buf/validate/validate.proto

      - name: Verify no schema drift
        run: |
          git diff --exit-code -- crates/prost-protovalidate-types/buf.lock crates/prost-protovalidate-types/proto/buf/validate/validate.proto
